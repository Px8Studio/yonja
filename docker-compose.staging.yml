# docker-compose.staging.yml
# =========================================================================
# Staging Environment (Cloud-Parity)
# Mirrors production architecture using Cloud LLMs (Groq) and managed DBs.
# =========================================================================

services:
  # ─────────────────────────────────────────────────────────────
  # LangGraph Dev Server (Cloud-Parity)
  # ─────────────────────────────────────────────────────────────
  langgraph:
    build:
      context: .
      dockerfile: Dockerfile.langgraph
    container_name: yonca-langgraph-staging
    environment:
      - YONCA_ENVIRONMENT=staging
      - YONCA_INFRASTRUCTURE_MODE=cloud
      - YONCA_LANGGRAPH_REQUIRED=true
      - YONCA_LLM_PROVIDER=groq
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LANGGRAPH_POSTGRES_URI=${YONCA_DATABASE_URL}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - yonca-network
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────
  # Yonca AI API (Staging)
  # ─────────────────────────────────────────────────────────────
  api:
    build:
      context: .
      target: production
      dockerfile: Dockerfile
    container_name: yonca-api-staging
    ports:
      - "8000:8000"
    environment:
      - YONCA_ENVIRONMENT=staging
      - YONCA_INFRASTRUCTURE_MODE=cloud
      - YONCA_LANGGRAPH_REQUIRED=true
      - YONCA_LANGGRAPH_BASE_URL=http://langgraph:2024
      - YONCA_LLM_PROVIDER=groq
      - GROQ_API_KEY=${GROQ_API_KEY}
      - YONCA_DATABASE_URL=${YONCA_DATABASE_URL}
    depends_on:
      postgres:
        condition: service_healthy
      langgraph:
        condition: service_healthy
    networks:
      - yonca-network
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────
  # Chainlit Demo UI (Staging)
  # ─────────────────────────────────────────────────────────────
  demo-ui:
    build:
      context: .
      dockerfile: demo-ui/Dockerfile
      target: production
    container_name: yonca-demo-ui-staging
    ports:
      - "8501:8501"
    environment:
      - YONCA_ENVIRONMENT=staging
      - YONCA_INFRASTRUCTURE_MODE=cloud
      - YONCA_LANGGRAPH_REQUIRED=true
      - YONCA_LANGGRAPH_BASE_URL=http://langgraph:2024
      - YONCA_API_URL=http://api:8000
      - YONCA_DATABASE_URL=${YONCA_DATABASE_URL}
      - CHAINLIT_DATABASE_URL=${YONCA_DATABASE_URL}
    depends_on:
      postgres:
        condition: service_healthy
      langgraph:
        condition: service_healthy
    networks:
      - yonca-network
    restart: unless-stopped
