# ğŸ·ï¸ Architecture: Naming & Observability

> **Purpose:** Clarify naming conventions and logging visibility gaps
> **Updated:** January 23, 2026

---

## ğŸ¯ Naming Clarification

### The "Scenario" Terminology Problem

**Current naming** (`farm_scenario_plans`, `save_farm_scenario()`) implies **physical farm planning**.

**Reality:** We're storing **conversation parameters for role-play**:
- Agent persona configurations
- Hypothetical thinking contexts
- Dialogue session settings

### Semantic Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONVERSATION CONTEXT (Not "Farm Scenario")          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ What: User-defined parameters for agent behavior    â”‚
â”‚ Contains:                                           â”‚
â”‚   â€¢ Crop type â†’ conversation focus                  â”‚
â”‚   â€¢ Region â†’ climate context for role               â”‚
â”‚   â€¢ Expertise level â†’ agent persona complexity      â”‚
â”‚   â€¢ Action categories â†’ dialogue scope              â”‚
â”‚                                                     â”‚
â”‚ Analogy: User = Director, Agent = Actor,            â”‚
â”‚          "Scenario" = Acting instructions           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Proposed Renames (Deferred)

| Old | New | Status |
|:----|:----|:------:|
| `farm_scenario_plans` | `conversation_contexts` | â¬œ Batch with next migration |
| `save_farm_scenario()` | `save_conversation_context()` | â¬œ Deferred |
| `ScenarioContext` | `ConversationContext` | â¬œ Deferred |

---

## ğŸ” LangGraph Observability

### The Visibility Gap

**What you see** (server-level):
```
[info] Worker stats    active=0 available=1 max=1
[info] Queue stats     n_pending=0 n_running=0
```

**What you need** (application-level):
- âŒ Node execution traces
- âŒ State transitions
- âŒ LLM call logs
- âŒ Message flow between nodes

### 3-Layer Logging Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: LangChain Native (Environment Variables)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LANGCHAIN_TRACING_V2=true                          â”‚
â”‚ set_verbose(True); set_debug(True)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: Node-Level Instrumentation (structlog)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Every node logs: entry, exit, decisions, errors    â”‚
â”‚ Include: thread_id, intent, conversation_stage     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: Langfuse Integration (Visual UI)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ See traces at http://localhost:3001                â”‚
â”‚ Trace view: node timings, LLM costs, state flow    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Environment Variables

```env
# Layer 1: LangChain/LangGraph Verbosity
LANGCHAIN_TRACING_V2=true
LANGCHAIN_PROJECT=yonca-dev
LOG_LEVEL=DEBUG

# Layer 3: Langfuse
LANGFUSE_PUBLIC_KEY=your_key
LANGFUSE_SECRET_KEY=your_secret
LANGFUSE_HOST=http://localhost:3001
```

---

## ğŸ’¡ Key Insight

> **Server logs** = "HTTP requests received, workers available"
> **Agent logs** = "Which node ran, what LLM said, what decision was made"
>
> You have #1 but need #2. Instrument the **agent**, not just the **server**.

---

## âœ… Implementation Status

| Phase | Task | Status |
|:------|:-----|:------:|
| 1 | Enable native logging (env vars) | â¬œ 15 min |
| 2 | Rename database schema | â¬œ Deferred |
| 3 | Add node-level logging | â¬œ 1 hour |
| 4 | Langfuse integration | â¬œ 30 min |

**Recommendation:** Start with Phase 1 (zero code changes, immediate visibility).

---

## ğŸ—ï¸ Complete System Architecture

### Component Relationship Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           YONCA AI SYSTEM ARCHITECTURE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   CHAINLIT UI   â”‚â”€â”€â”€â”€â–¶â”‚   LANGGRAPH     â”‚â”€â”€â”€â”€â–¶â”‚   MCP SERVERS   â”‚           â”‚
â”‚  â”‚   (demo-ui/)    â”‚     â”‚  DEV SERVER     â”‚     â”‚   (External)    â”‚            â”‚
â”‚  â”‚   Port: 8501    â”‚     â”‚  Port: 2024     â”‚     â”‚   Weather/Rules â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                       â”‚                                             â”‚
â”‚           â”‚  HTTP/SSE             â”‚  Loads Graph                                â”‚
â”‚           â”‚                       â–¼                                             â”‚
â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚           â”‚              â”‚ AGENT GRAPH     â”‚â—€â”€â”€ src/yonca/agent/graph.py       |
â”‚           â”‚              â”‚ (StateGraph)    â”‚                                    â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                       â”‚                                             â”‚
â”‚           â”‚                       â”‚ Invokes Nodes                               â”‚
â”‚           â”‚                       â–¼                                             â”‚
â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚           â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚           â”‚              â”‚         SPECIALIST NODES        â”‚                    â”‚
â”‚           â”‚              â”‚ â€¢ supervisor    (routing)       â”‚                    â”‚
â”‚           â”‚              â”‚ â€¢ context_loader (farm data)    â”‚                   â”‚
â”‚           â”‚              â”‚ â€¢ agronomist   (crop advice)    â”‚                   â”‚
â”‚           â”‚              â”‚ â€¢ weather      (forecasts)      â”‚                   â”‚
â”‚           â”‚              â”‚ â€¢ nl_to_sql    (data queries)   â”‚                   â”‚
â”‚           â”‚              â”‚ â€¢ validator    (rule checks)    â”‚                   â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                                    â”‚
â”‚           â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   POSTGRESQL    â”‚     â”‚     REDIS       â”‚     â”‚    LANGFUSE     â”‚          â”‚
â”‚  â”‚   Port: 5433    â”‚     â”‚   Port: 6379    â”‚     â”‚   Port: 3001    â”‚          â”‚
â”‚  â”‚   Users/Threads â”‚     â”‚  Checkpoints    â”‚     â”‚   Tracing UI    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: User Message â†’ AI Response

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MESSAGE PROCESSING PIPELINE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  [1] USER INPUT                                                                  â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚  â”‚   CHAINLIT UI      â”‚  demo-ui/app.py::on_message()                           â”‚
â”‚  â”‚   â€¢ OAuth session  â”‚                                                         â”‚
â”‚  â”‚   â€¢ Farm context   â”‚                                                         â”‚
â”‚  â”‚   â€¢ Thread mgmt    â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚            â”‚                                                                     â”‚
â”‚            â”‚ HTTP POST /threads/{id}/runs/stream                                â”‚
â”‚            â”‚ Content: AgentState (serialized)                                   â”‚
â”‚            â–¼                                                                     â”‚
â”‚  [2] LANGGRAPH DEV SERVER (localhost:2024)                                      â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”‚ Loads: langgraph.json â†’ src/yonca/agent/graph.py:create_agent_graph     â”‚
â”‚      â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                    STATE MACHINE EXECUTION                         â”‚         â”‚
â”‚  â”‚                                                                    â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ supervisorâ”‚â”€â”€â”€â–¶â”‚  context  â”‚â”€â”€â”€â–¶â”‚ specialistâ”‚â”€â”€â”€â–¶â”‚validatorâ”‚  â”‚         â”‚
â”‚  â”‚  â”‚ (routing) â”‚    â”‚  loader   â”‚    â”‚ (agro/wx) â”‚    â”‚ (rules) â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚       â”‚                                                   â”‚       â”‚         â”‚
â”‚  â”‚       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚       â”‚         â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       END        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚         â”‚
â”‚  â”‚                   â”‚ (response ready) â”‚                           â”‚         â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â”‚                                                                     â”‚
â”‚            â”‚ SSE Stream (Server-Sent Events)                                    â”‚
â”‚            â–¼                                                                     â”‚
â”‚  [3] CHAINLIT RESPONSE                                                          â”‚
â”‚      â€¢ Token streaming                                                          â”‚
â”‚      â€¢ Thinking steps                                                           â”‚
â”‚      â€¢ Feedback buttons                                                         â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Codebase Component Index

### Where Is What? Quick Reference

```
yonca/
â”œâ”€â”€ demo-ui/                          ğŸ–¥ï¸ CHAINLIT UI LAYER
â”‚   â”œâ”€â”€ app.py                        Main UI application (3000+ lines)
â”‚   â”œâ”€â”€ data_layer.py                 PostgreSQL persistence for threads
â”‚   â”œâ”€â”€ storage_postgres.py           File storage in PostgreSQL
â”‚   â”œâ”€â”€ config.py                     UI-specific settings
â”‚   â””â”€â”€ alem_persona.py               User persona generation
â”‚
â”œâ”€â”€ src/yonca/                        ğŸ§  CORE INTELLIGENCE
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                        ğŸ“Š LANGGRAPH AGENT
â”‚   â”‚   â”œâ”€â”€ graph.py                  StateGraph definition (entry point)
â”‚   â”‚   â”œâ”€â”€ state.py                  AgentState TypedDict + serialization
â”‚   â”‚   â”œâ”€â”€ memory.py                 Redis/Postgres checkpointing
â”‚   â”‚   â””â”€â”€ nodes/                    Specialist processing nodes
â”‚   â”‚       â”œâ”€â”€ supervisor.py         Intent routing logic
â”‚   â”‚       â”œâ”€â”€ context_loader.py     Farm/user context loading
â”‚   â”‚       â”œâ”€â”€ agronomist.py         Crop advice generation
â”‚   â”‚       â”œâ”€â”€ weather.py            Weather-based recommendations
â”‚   â”‚       â”œâ”€â”€ nl_to_sql.py          Natural language â†’ SQL
â”‚   â”‚       â”œâ”€â”€ sql_executor.py       Execute generated SQL
â”‚   â”‚       â”œâ”€â”€ validator.py          Rule validation
â”‚   â”‚       â””â”€â”€ vision_to_action.py   Image analysis (future)
â”‚   â”‚
â”‚   â”œâ”€â”€ langgraph/                    ğŸ”Œ LANGGRAPH CLIENT
â”‚   â”‚   â”œâ”€â”€ client.py                 HTTP client for LangGraph Dev Server
â”‚   â”‚   â””â”€â”€ __init__.py               Exports LangGraphClient
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/                          ğŸ”— MCP CLIENT LAYER
â”‚   â”‚   â”œâ”€â”€ client.py                 MCPClient for calling MCP servers
â”‚   â”‚   â”œâ”€â”€ adapters.py               Tool adapters for LangGraph
â”‚   â”‚   â”œâ”€â”€ config.py                 MCP server configuration
â”‚   â”‚   â””â”€â”€ handlers/                 Protocol handlers
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp_server/                   ğŸ›¡ï¸ INTERNAL MCP SERVER (ZekaLab)
â”‚   â”‚   â”œâ”€â”€ main.py                   FastMCP server entry point
â”‚   â”‚   â”œâ”€â”€ zekalab_fastmcp.py        Rule engine MCP tools
â”‚   â”‚   â”œâ”€â”€ tools/                    Tool implementations
â”‚   â”‚   â””â”€â”€ resources/                Static resources
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                          ğŸŒ FASTAPI REST LAYER
â”‚   â”‚   â”œâ”€â”€ main.py                   FastAPI application
â”‚   â”‚   â”œâ”€â”€ routes/                   API route handlers
â”‚   â”‚   â”œâ”€â”€ schemas/                  Pydantic request/response models
â”‚   â”‚   â””â”€â”€ middleware/               Auth, CORS, logging
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/                          ğŸ¤– LLM PROVIDERS
â”‚   â”‚   â””â”€â”€ (provider implementations)
â”‚   â”‚
â”‚   â”œâ”€â”€ observability/                ğŸ“Š TRACING & LOGGING
â”‚   â”‚   â””â”€â”€ langfuse.py               Langfuse integration
â”‚   â”‚
â”‚   â””â”€â”€ rules/                        ğŸ“‹ AGRONOMY RULES ENGINE
â”‚       â””â”€â”€ (rule definitions)
â”‚
â”œâ”€â”€ langgraph.json                    âš™ï¸ LangGraph Dev Server config
â”œâ”€â”€ docker-compose.local.yml          ğŸ³ Local infrastructure
â””â”€â”€ alembic/                          ğŸ—„ï¸ Database migrations
```

### Component Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        COMPONENT DEPENDENCY GRAPH                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                          â”‚    demo-ui/app.py   â”‚                                 â”‚
â”‚                          â”‚    (Chainlit UI)    â”‚                                 â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                     â”‚                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚                â”‚                â”‚                          â”‚
â”‚                    â–¼                â–¼                â–¼                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â”‚ data_layer   â”‚  â”‚ langgraph/   â”‚  â”‚ alem_persona â”‚                    â”‚
â”‚         â”‚ (persistence)â”‚  â”‚   client.py  â”‚  â”‚ (JIT users)  â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                  â”‚                                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚  LangGraph Dev Server     â”‚                                â”‚
â”‚                    â”‚  (langgraph dev)          â”‚                                â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                  â”‚                                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚                           â”‚                                â”‚
â”‚                    â–¼                           â–¼                                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚ agent/graph  â”‚            â”‚ agent/state  â”‚                            â”‚
â”‚         â”‚ (StateGraph) â”‚            â”‚ (TypedDict)  â”‚                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                â”‚                                                                 â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚       â”‚                 â”‚                        â”‚                              â”‚
â”‚       â–¼                 â–¼                        â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ nodes/  â”‚      â”‚ mcp/    â”‚             â”‚ llm/    â”‚                           â”‚
â”‚  â”‚ *       â”‚      â”‚ client  â”‚             â”‚ *       â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                        â”‚                                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚           â”‚                         â”‚                                           â”‚
â”‚           â–¼                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ External MCP    â”‚      â”‚ mcp_server/     â”‚                                   â”‚
â”‚  â”‚ (OpenWeather)   â”‚      â”‚ (ZekaLab rules) â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— LangGraph â†” MCP â†” Chainlit Relationship

### Conceptual Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     THREE-LAYER INTEGRATION MODEL                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  LAYER 1: PRESENTATION (Chainlit)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ User authentication (OAuth)                                                  â”‚
â”‚  â€¢ Chat interface rendering                                                      â”‚
â”‚  â€¢ Thread/message persistence                                                    â”‚
â”‚  â€¢ File uploads                                                                  â”‚
â”‚  â€¢ Settings panels                                                              â”‚
â”‚                                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                              HTTP/SSE Protocol                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                  â”‚
â”‚  LAYER 2: ORCHESTRATION (LangGraph)                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â€¢ State machine execution                                                       â”‚
â”‚  â€¢ Node routing (supervisor â†’ specialist)                                        â”‚
â”‚  â€¢ Checkpointing (Redis/Postgres)                                               â”‚
â”‚  â€¢ Tool binding                                                                  â”‚
â”‚                                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                              MCP Protocol (JSON-RPC)                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                  â”‚
â”‚  LAYER 3: DATA SERVICES (MCP Servers)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â€¢ Weather data (OpenWeather MCP)                                               â”‚
â”‚  â€¢ Agronomy rules (ZekaLab internal MCP)                                        â”‚
â”‚  â€¢ Future: EKTÄ°S, CBAR, Satellite, etc.                                         â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protocol Details

| Layer | Protocol | Port | Direction |
|-------|----------|------|-----------|
| Chainlit â†’ LangGraph | HTTP + SSE | 2024 | Request/Stream |
| LangGraph â†’ MCP | stdio/HTTP | varies | JSON-RPC 2.0 |
| Chainlit â†’ PostgreSQL | asyncpg | 5433 | SQL |
| LangGraph â†’ Redis | redis-py | 6379 | Checkpointing |

### Code Entry Points

| What | Where | Key Function |
|------|-------|--------------|
| UI starts | `demo-ui/app.py` | `@cl.on_chat_start` |
| Message handling | `demo-ui/app.py` | `@cl.on_message` |
| LangGraph invocation | `src/yonca/langgraph/client.py` | `LangGraphClient.stream()` |
| Graph definition | `src/yonca/agent/graph.py` | `create_agent_graph()` |
| State schema | `src/yonca/agent/state.py` | `AgentState` TypedDict |
| MCP calls | `src/yonca/mcp/client.py` | `MCPClient.call_tool()` |

---

## âš ï¸ Known Technical Debt

| Area | Issue | Impact | Priority |
|------|-------|--------|----------|
| `langgraph-api` | Version 0.5.42 is EOL | Security updates missing | ğŸ”´ HIGH |
| Data layer | Signature mismatch with Chainlit | Thread persistence errors | âœ… FIXED |
| Storage client | Not initialized warning | Elements not persisted | ğŸŸ¡ MEDIUM |
| Naming | `farm_scenario_plans` vs `conversation_contexts` | Semantic confusion | ğŸŸ¢ LOW |
