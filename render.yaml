# Render.com Blueprint for Yonca AI
# https://render.com/docs/blueprint-spec
#
# Deploy with: render blueprint apply
# Or connect GitHub repo to Render Dashboard

services:
  # ============================================
  # Yonca API (FastAPI Backend)
  # ============================================
  - type: web
    name: yonca-api
    runtime: python
    plan: starter  # $7/month, can upgrade for production
    region: frankfurt  # Closest to Azerbaijan
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn yonca.api.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      # Deployment mode
      - key: DEPLOYMENT_MODE
        value: cloud
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false

      # Python path
      - key: PYTHONPATH
        value: /opt/render/project/src/src

      # LLM Provider (Gemini for cloud)
      - key: LLM_PROVIDER
        value: gemini
      - key: GEMINI_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: GEMINI_MODEL
        value: gemini-2.0-flash

      # Groq as fallback
      - key: GROQ_API_KEY
        sync: false
      - key: GROQ_MODEL
        value: llama-3.3-70b-versatile

      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: yonca-db
          property: connectionString

      # Redis (optional - use Upstash free tier or PostgreSQL checkpointing)
      # If REDIS_URL is not set, checkpointing falls back to PostgreSQL
      - key: REDIS_URL
        sync: false  # Optional: Set to Upstash URL in dashboard

      # Checkpointing backend (auto = Redis → Postgres → Memory)
      - key: CHECKPOINTER_BACKEND
        value: auto

      # Security (generate with: openssl rand -hex 32)
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRY_HOURS
        value: 24

      # Rate limiting
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: 30
      - key: RATE_LIMIT_BURST
        value: 50

      # CORS (add your frontend domains)
      - key: CORS_ORIGINS
        value: https://yonca-demo.onrender.com,https://yonca.az

      # Observability
      - key: LOG_LEVEL
        value: INFO
      - key: LOG_FORMAT
        value: json

  # ============================================
  # Chainlit Demo UI
  # ============================================
  - type: web
    name: yonca-demo
    runtime: python
    plan: starter
    region: frankfurt
    buildCommand: pip install -r requirements.txt && pip install -r demo-ui/requirements.txt
    startCommand: cd demo-ui && chainlit run app.py --host 0.0.0.0 --port $PORT
    healthCheckPath: /
    envVars:
      # Python path
      - key: PYTHONPATH
        value: /opt/render/project/src/src:/opt/render/project/src/demo-ui

      # LLM Provider
      - key: LLM_PROVIDER
        value: gemini
      - key: GEMINI_API_KEY
        sync: false
      - key: GEMINI_MODEL
        value: gemini-2.0-flash

      # Groq fallback
      - key: GROQ_API_KEY
        sync: false
      - key: GROQ_MODEL
        value: llama-3.3-70b-versatile

      # Redis (optional - use Upstash free tier, falls back to PostgreSQL)
      - key: REDIS_URL
        sync: false  # Optional: Set to Upstash URL in dashboard

      # Checkpointing backend (auto = Redis → Postgres → Memory)
      - key: CHECKPOINTER_BACKEND
        value: auto

      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: yonca-db
          property: connectionString

      # API URL (for API client pattern)
      - key: YONCA_API_URL
        value: https://yonca-api.onrender.com

# ============================================
# Langfuse (Self-Hosted Observability)
# ============================================
# LLM tracing & analytics with 100% data residency
  - type: web
    name: yonca-langfuse
    runtime: docker
    plan: starter  # $7/month
    region: frankfurt
    dockerfilePath: ./Dockerfile.langfuse
    healthCheckPath: /api/public/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: langfuse-db
          property: connectionString
      - key: DIRECT_URL
        fromDatabase:
          name: langfuse-db
          property: connectionString
      - key: NEXTAUTH_SECRET
        generateValue: true
      - key: SALT
        generateValue: true
      - key: NEXTAUTH_URL
        value: https://yonca-langfuse.onrender.com
      - key: TELEMETRY_ENABLED
        value: false
      - key: AUTH_DISABLE_SIGNUP
        value: false  # Allow first user registration

# ============================================
# Database (PostgreSQL - Application)
# ============================================
databases:
  - name: yonca-db
    plan: starter  # $7/month, 1GB storage
    region: frankfurt
    databaseName: yonca
    user: yonca
    postgresMajorVersion: 15

  - name: langfuse-db
    plan: starter  # $7/month for Langfuse data
    region: frankfurt
    databaseName: langfuse
    user: langfuse
    postgresMajorVersion: 15

# ============================================
# Checkpointing Strategy (No Extra Redis Needed!)
# ============================================
# LangGraph checkpoints now use PostgreSQL via langgraph-checkpoint-postgres
# This saves ~$10/month vs managed Redis while providing same persistence
#
# For higher performance (optional), use Upstash Redis (free tier):
# Set REDIS_URL=redis://default:xxx@xxx.upstash.io:6379
