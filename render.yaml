# Render.com Blueprint for Yonca AI
# https://render.com/docs/blueprint-spec
#
# Deploy with: render blueprint apply
# Or connect GitHub repo to Render Dashboard

services:
  # ============================================
  # Yonca API (FastAPI Backend)
  # ============================================
  - type: web
    name: yonca-api
    runtime: python
    plan: starter  # $7/month, can upgrade for production
    region: frankfurt  # Closest to Azerbaijan
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn yonca.api.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      # Deployment Configuration (Two-Axis Model)
      - key: YONCA_ENVIRONMENT
        value: production
      - key: YONCA_INFRASTRUCTURE_MODE
        value: cloud
      - key: YONCA_LANGGRAPH_REQUIRED
        value: true

      # LangGraph Connector
      - key: YONCA_LANGGRAPH_BASE_URL
        value: https://yonca-langgraph.onrender.com
      - key: YONCA_LANGGRAPH_GRAPH_ID
        value: yonca_agent

      # LLM Provider (Gemini for cloud)
      - key: YONCA_LLM_PROVIDER
        value: gemini
      - key: GEMINI_API_KEY
        sync: false
      - key: GEMINI_MODEL
        value: gemini-2.0-flash

      # Database
      - key: YONCA_DATABASE_URL
        fromDatabase:
          name: yonca-db
          property: connectionString

      # Security
      - key: YONCA_JWT_SECRET
        generateValue: true
      - key: YONCA_JWT_ALGORITHM
        value: HS256

      # Observability
      - key: YONCA_LANGFUSE_ENABLED
        value: true
      - key: YONCA_LANGFUSE_HOST
        value: https://yonca-langfuse.onrender.com
      - key: LOG_LEVEL
        value: INFO
    depends_on:
      - yonca-langgraph

  # ============================================
  # Chainlit Demo UI
  # ============================================
  - type: web
    name: yonca-demo
    runtime: python
    plan: starter
    region: frankfurt
    buildCommand: pip install -r requirements.txt && pip install -r demo-ui/requirements.txt
    startCommand: cd demo-ui && chainlit run app.py --host 0.0.0.0 --port $PORT
    healthCheckPath: /
    envVars:
      # Deployment settings
      - key: YONCA_ENVIRONMENT
        value: production
      - key: YONCA_INFRASTRUCTURE_MODE
        value: cloud
      - key: YONCA_LANGGRAPH_REQUIRED
        value: true

      # Service Connectors
      - key: YONCA_LANGGRAPH_BASE_URL
        value: https://yonca-langgraph.onrender.com
      - key: YONCA_API_URL
        value: https://yonca-api.onrender.com

      # Database
      - key: YONCA_DATABASE_URL
        fromDatabase:
          name: yonca-db
          property: connectionString
      - key: CHAINLIT_DATABASE_URL
        fromDatabase:
          name: yonca-db
          property: connectionString

      # Python path
      - key: PYTHONPATH
        value: /opt/render/project/src/src:/opt/render/project/src/demo-ui
    depends_on:
      - yonca-api
      - yonca-langgraph

# ============================================
# LangGraph Runtime (Production Agent Server)
# ============================================
  - type: web
    name: yonca-langgraph
    runtime: docker
    plan: starter
    region: frankfurt
    dockerfilePath: Dockerfile.langgraph
    healthCheckPath: /health
    envVars:
      - key: YONCA_ENVIRONMENT
        value: production
      - key: YONCA_INFRASTRUCTURE_MODE
        value: cloud
      - key: YONCA_LANGGRAPH_REQUIRED
        value: true
      - key: YONCA_LLM_PROVIDER
        value: gemini
      - key: GEMINI_API_KEY
        sync: false
      - key: LANGGRAPH_POSTGRES_URI
        fromDatabase:
          name: yonca-db
          property: connectionString
      - key: PYTHONPATH
        value: /app/src

# ============================================
# Langfuse (Self-Hosted Observability)
# ============================================
# LLM tracing & analytics with 100% data residency
  - type: web
    name: yonca-langfuse
    runtime: docker
    plan: starter  # $7/month
    region: frankfurt
    dockerfilePath: ./Dockerfile.langfuse
    healthCheckPath: /api/public/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: langfuse-db
          property: connectionString
      - key: DIRECT_URL
        fromDatabase:
          name: langfuse-db
          property: connectionString
      - key: NEXTAUTH_SECRET
        generateValue: true
      - key: SALT
        generateValue: true
      - key: NEXTAUTH_URL
        value: https://yonca-langfuse.onrender.com
      - key: TELEMETRY_ENABLED
        value: false
      - key: AUTH_DISABLE_SIGNUP
        value: false  # Allow first user registration

# ============================================
# Database (PostgreSQL - Application)
# ============================================
databases:
  - name: yonca-db
    plan: starter  # $7/month, 1GB storage
    region: frankfurt
    databaseName: yonca
    user: yonca
    postgresMajorVersion: 15

  - name: langfuse-db
    plan: starter  # $7/month for Langfuse data
    region: frankfurt
    databaseName: langfuse
    user: langfuse
    postgresMajorVersion: 15

# ============================================
# Checkpointing Strategy (No Extra Redis Needed!)
# ============================================
# LangGraph checkpoints now use PostgreSQL via langgraph-checkpoint-postgres
# This saves ~$10/month vs managed Redis while providing same persistence
#
# For higher performance (optional), use Upstash Redis (free tier):
# Set REDIS_URL=redis://default:xxx@xxx.upstash.io:6379
